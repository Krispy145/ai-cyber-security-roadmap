#!/usr/bin/env bash
set -euo pipefail

# Skip pre-commit if SKIP environment variable is set
if [[ "${SKIP:-}" == "pre-commit" ]]; then
  echo "Skipping pre-commit hooks (SKIP=pre-commit)"
  exit 0
fi

REPO_ROOT="$(git rev-parse --show-toplevel)"
cd "$REPO_ROOT"

echo "→ Validating manifest.json..."
python3 scripts/validate_manifest.py

echo "→ Checking README generation..."
python3 scripts/manifest2readme.py

echo "→ Standardizing repository READMEs..."
python3 scripts/standardize_readmes.py

echo "→ Adding cover URLs to manifest..."
python3 scripts/add_cover_urls.py

# Stage any README changes that were made
if ! git diff --quiet -- "README.md"; then
  echo "→ Staging updated README.md..."
  git add README.md
fi

# Check if any README files were modified (should be auto-committed now)
if ! git diff --quiet -- "**/README.md"; then
  echo "✖ README files still need to be updated from manifest."
  echo "This should have been handled automatically. Check the update script."
  git --no-pager diff -- "**/README.md"
  exit 1
fi

echo "✓ Pre-commit checks passed."
